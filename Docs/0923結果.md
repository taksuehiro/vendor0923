RAG ステージング統合：技術メモ（詳細版）
0. 要約（TL;DR）

目的：旧 Streamlit RAG を廃止し、Next.js（Amplify）＋ FastAPI（ECS/ALB） へ全面移行。

現状：ECS 上の FastAPI（RAG 実装）は稼働／ALB /health OK。Amplify もビルド成功。

ブロッカー：Amplify(HTTPS) → ALB(HTTP) で Mixed Content により /search がブラウザでブロック。

次アクション：ALB の HTTPS 化（ACM 証明書＋443 リスナー追加）→ Amplify の API URL を https://... に更新。

1. アーキテクチャ（現行ステージング）
Browser (HTTPS)
   │
   ▼
Amplify Hosting (Next.js, HTTPS, *.amplifyapp.com)
   │  fetch POST /search  ← NEXT_PUBLIC_API_BASE
   │
   ▼
ALB (現状: HTTP :80 のみ → 要 :443 追加)
   │
   ▼
ECS/Fargate  (vendor-mock-cluster / vendor-mock-service)
   └─ Task (vendor-mock-task:1)  FastAPI (uvicorn)
        - /health      : 200 OK
        - /search      : RAG 実装（FAISS + OpenAI Embeddings）
        - CloudWatch Logs: /ecs/vendor-mock-api

2. バックエンド（FastAPI / RAG）実装メモ
2.1 主要ファイル

backend/main.py

GET /health : {"status":"ok"}

POST /search : RAG 実装（FAISS 検索 → 整形レスポンス）

CORS：ALLOWED_ORIGINS を環境変数で注入

backend/rag_core.py

FAISS + OpenAI Embeddings

ベクトルストア永続化（ディレクトリ VECTOR_DIR）

vendors.json を元に 更新検知＆再構築

backend/requirements.txt：fastapi, uvicorn, python-dotenv, faiss-cpu, ほか

.env.local（ローカル）

OPENAI_API_KEY, VECTOR_DIR, VENDOR_DATA_JSON, ALLOWED_ORIGINS

2.2 API スキーマ（統一）

Request

{ "query": "契約管理に強いベンダー", "top_k": 5 }


Response

{
  "hits": [
    {
      "id": "V-XXX",
      "title": "Vendor Name",
      "score": 0.42,
      "snippet": "・・・",
      "metadata": { "status": "面談済", "category": "SaaS" }
    }
  ]
}


※ フロント型 SearchResult と完全一致。metadata.status/category は 常に含める（空でも）。

2.3 CORS

タスク定義または環境変数で：

ALLOWED_ORIGINS=https://<AMPLIFY_DOMAIN>,https://<CUSTOM_DOMAIN>


main.py 側で CORSMiddleware に渡す。

3. フロントエンド（Next.js / Amplify）
3.1 変更点

トップページ / と /search の検索処理を 共通化（モック廃止 → API 呼び出しへ）

API ベース URL は process.env.NEXT_PUBLIC_API_BASE を必ず経由

ローカル: http://localhost:8000

ステージング: https://<ALB_DNS または独自ドメイン>

3.2 動作確認（ブラウザ DevTools）

Network > Fetch/XHR → search をクリック

Request URL が https://.../search（ALB か独自ドメイン）になっている

Mixed Content が消えていること

4. デプロイ・運用
4.1 コンテナ & ECS
# ビルド & Push（ローカル/CI）
docker build -t vendor-mock-api:latest backend
docker tag vendor-mock-api:latest 067717894185.dkr.ecr.ap-northeast-1.amazonaws.com/vendor-mock-api:latest
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin 067717894185.dkr.ecr.ap-northeast-1.amazonaws.com
docker push 067717894185.dkr.ecr.ap-northeast-1.amazonaws.com/vendor-mock-api:latest

# 再デプロイ
aws ecs update-service \
  --cluster vendor-mock-cluster \
  --service vendor-mock-service \
  --force-new-deployment \
  --region ap-northeast-1

# 状態確認
aws ecs describe-services \
  --cluster vendor-mock-cluster \
  --services vendor-mock-service \
  --region ap-northeast-1 \
  --query "services[0].{desired:desiredCount,running:runningCount,pending:pendingCount}"

4.2 ヘルスチェック
ALB_DNS=vendor-mock-alb-29008868.ap-northeast-1.elb.amazonaws.com
curl -s http://$ALB_DNS/health   # => {"status":"ok"}

5. ブロッカー：Mixed Content の解消（最優先）
5.1 対応手順（ALB を HTTPS 化）

ACM 証明書の発行（リージョン：ap-northeast-1）

ドメイン：

暫定：ALB DNS は証明書割当不可 → 独自ドメイン or 別名（Route53 + CNAME） 推奨

例：api-vendor-stg.example.com を ALB に CNAME で向ける

ALB に 443 リスナー追加（ACM 証明書を指定）

ターゲットグループは既存の vendor-mock-tg(HTTP:8080) を継続利用

ALB:443(HTTPS) → ALB 内部:HTTP → ECS:8080

フロントの環境変数更新

NEXT_PUBLIC_API_BASE=https://api-vendor-stg.example.com


Amplify 再デプロイ → ブラウザで /search 成功まで確認

参考 CLI（証明書は事前に ACM で発行・検証済みの ARN を使用）

# HTTPS リスナー追加（置換値：<ALB_ARN> / <CERT_ARN> / <TG_ARN>）
aws elbv2 create-listener \
  --load-balancer-arn <ALB_ARN> \
  --protocol HTTPS \
  --port 443 \
  --certificates CertificateArn=<CERT_ARN> \
  --default-actions Type=forward,TargetGroupArn=<TG_ARN> \
  --region ap-northeast-1

6. Secrets / 環境変数
6.1 バックエンド（ECS タスク定義）

OPENAI_API_KEY … Secrets Manager から参照

VECTOR_DIR, VENDOR_DATA_JSON … タスク定義の環境変数

ALLOWED_ORIGINS … Amplify ドメイン（カンマ区切り）

6.2 フロント（Amplify 環境変数）
NEXT_PUBLIC_API_BASE=https://api-vendor-stg.example.com

7. 監視・運用
7.1 ログ

CloudWatch Logs /ecs/vendor-mock-api

起動エラー（CannotPullContainerError / 権限）

Embedding 失敗（OPENAI_API_KEY 未設定）

CORS エラー

7.2 典型トラブルと対処
症状	原因	対処
running=0 / pending が増減	ECR Pull 失敗 / ロググループ未作成	ECR 権限・リポ存在確認、/ecs/vendor-mock-api 作成 → 再デプロイ
CannotPullContainerError	タグ不一致 / 認証切れ	docker tag/push やり直し、ECR ログイン
5xx / ヘルス ×	FastAPI 起動失敗	CloudWatch ログ確認（ポート/HC パス /health）
ブラウザ Failed to fetch	Mixed Content	ALB を HTTPS 化して NEXT_PUBLIC_API_BASE=https://...
403 CORS	ALLOWED_ORIGINS 未設定	Amplify ドメインを追加、タスク再デプロイ
8. テスト計画（最小）

単体：/health 200、/search に対してモックでない vendors.json の結果が返る

結合：Amplify UI から検索 → Network の Request URL が https://.../search、200 & 想定 JSON

回帰：再デプロイ（--force-new-deployment）でローリング更新が成功

9. セキュリティ／コストの注意

Secrets は Secrets Manager 経由でタスク定義に注入（直接環境変数にべた書きしない）

ALB の 80→443 移行後は HTTP→HTTPS へリダイレクト（追加リスナー＆ルール）を検討

Embedding コスト：データ更新時のみ再構築（更新検知あり）

10. 今回行ったこと（履歴）

RAG 実装（FAISS + OpenAI Embeddings）導入、/search API 実装

.env.local 読み込み不具合修正（load_dotenv('.env.local') 明示）

vendors.json による ベクトルストア再構築（更新検知/ログ強化）

フロントのモック排除 → API 呼び出し統一 (NEXT_PUBLIC_API_BASE)

ECS/ECR/ALB 構築・ロググループ作成・再デプロイ運用確立

Amplify ビルド時の 型不整合 解消（SearchResult へ統一）

Mixed Content を特定（HTTPS 必要性判明）

11. 次にやること（チェックリスト）

 ACM 証明書（api-vendor-stg.<your-domain>）発行・検証（ap-northeast-1）

 Route53 で api-vendor-stg → ALB CNAME 登録

 ALB :443 リスナー追加（証明書アタッチ、TG を 8080 にフォワード）

 Amplify：NEXT_PUBLIC_API_BASE=https://api-vendor-stg.<your-domain> に更新 → 再デプロイ

 ブラウザ Network：Request URL=https://api-vendor-stg.../search & 200 を確認

 CloudWatch Logs で検索リクエスト流入＆エラー無いこと確認

[ ]（任意）ALB :80 → 301 で :443 にリダイレクト

[ ]（任意）API スキーマを OpenAPI に明文化（/docs で確認）

12. 補足：Bedrock 連携（将来）

ap-northeast-1 で DeepSeek-V3.1, Qwen Coder 等のモデル利用可能なのを確認済み（aws bedrock list-foundation-models）。

Embedding/LLM を Bedrock に寄せる場合は、リージョン・モデル ID・IAM の再設計が必要。

必要ならこのまま Docs/移行計画_ステージング統合.md としてリポに入れる文章に整形できます。
次の作業は ALB の HTTPS 化から進めましょう。準備できていれば、証明書の発行〜リスナー追加のコマンド列もすぐ出します。