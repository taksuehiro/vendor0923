# RAGシステム アーキテクチャ設計書

## 🏗️ システムアーキテクチャ全体像

### 1. レイヤー構造
```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  Streamlit UI   │  │   CLI Tools     │  │  Browse UI   │ │
│  │  (統合アプリ)    │  │  (reindex.py)   │  │  (分類ビュー) │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Indexer       │  │   Vectorstore   │  │    Chain     │ │
│  │  (統合管理)      │  │   (FAISS管理)   │  │  (RAG処理)   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Data Processing Layer                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  JSON Loader    │  │  MD Splitter    │  │  Data Models │ │
│  │  (構造化データ)  │  │  (テキスト分割)  │  │  (Pydantic)  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   OpenAI API    │  │   FAISS Index   │  │  File System │ │
│  │  (Embedding)    │  │  (ベクトルDB)    │  │  (永続化)    │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 📁 ファイル構成

```
vendor0922/
├── app_streamlit.py              # メインUI（統合アプリ）
├── config.py                     # 設定ファイル
├── requirements.txt              # 依存関係
├── data/                         # データ置き場
│   └── vendors.json              # ベンダーデータ（JSON形式）
├── rag_core/                     # コア機能
│   ├── data_models.py           # Pydanticモデル（Vendor）
│   ├── loaders/
│   │   └── json_loader.py       # JSON専用ローダー
│   ├── splitter.py              # Markdown専用分割器
│   ├── indexer.py               # 統合インデクサ
│   ├── vectorstore.py           # FAISS管理
│   ├── llm.py                   # OpenAI接続
│   └── chain.py                 # RAGチェーン
├── tools/
│   └── reindex.py               # CLI再インデックス
└── .vectorstores/               # ベクトルストア保存先
    └── vendors_faiss/
```

## 🔄 データフロー詳細

### 1. データ読み込みフロー
```
vendors.json → JSON Loader → 正規化 → Pydantic検証 → Document生成
     ↓
Markdown分割 → MD Splitter → ベンダー単位分割 → メタデータ抽出
     ↓
統合 → Indexer → ベクトル化 → FAISS保存
```

### 2. 検索・回答フロー
```
ユーザークエリ → ベクトル検索 → 関連文書取得 → LLM統合 → 自然回答生成
     ↓
MMR適用 → スコア閾値 → 文脈構築 → プロンプト生成 → 回答出力
```

### 3. ブラウズ・分類フロー
```
ドキュメント → メタデータ抽出 → 集計処理 → フィルタリング → 階層表示
     ↓
集計カード → ドリルダウン → リスト表示 → 詳細表示
```

## 🧩 コンポーネント詳細

### 1. データ処理層

#### JSON Loader (`rag_core/loaders/json_loader.py`)
**機能:**
- vendors.jsonの構造をPydanticモデルに正規化
- 価格帯の自動分類（man_month_jpy → 低/中/高/要見積）
- 1ベンダー=1ドキュメント（chunk_size=0固定）
- メタデータの自動抽出・補完
- ブラウズUI用属性の展開

**正規化例:**
```python
# 入力データ
{
  "engagement": {"status": "面談済"},
  "commercials": {"man_month_jpy": "200-300"},
  "capabilities": ["AI", "ML"],
  "corporate": {"listed": "未上場", "investors": ["投資家A"]},
  "tags": {"use_cases": ["機械学習", "最適化"]}
}

# 正規化後
{
  "status": "面談済",
  "price_range": "高",
  "industry_tags": ["AI", "ML"],
  "listed": "未上場",
  "investors": ["投資家A"],
  "use_cases": ["機械学習", "最適化"]
}
```

**ブラウズUI用メタデータ:**
```python
metadata = {
    # 基本情報
    "vendor_id": "V-LiberCraft",
    "name": "LiberCraft",
    "status": "面談済",
    "category": "スクラッチ",
    
    # ブラウズUI用
    "type": "スクラッチ",                    # SaaS/スクラッチ/SI
    "listed": "未上場",                      # 上場/未上場/不明
    "investors": ["投資家A", "投資家B"],     # 投資家リスト
    "employees_band": "1-10",               # 従業員規模
    "is_scratch": True,                     # スクラッチ開発フラグ
    "use_cases": ["機械学習", "最適化"],     # 得意分野タグ
    "industries": ["製造業", "金融"],        # 業界タグ
    "departments": ["法務", "人事"],         # 部門タグ
}
```

#### MD Splitter (`rag_core/splitter.py`)
**機能:**
- Markdown専用のベンダー分割
- 正規表現による見出し検出（### ベンダー n:）
- ベンダー単位での分割 + 条件付き二次分割
- vendor_name, vendor_idの自動抽出

**分割ロジック:**
```python
chunk_size=0 → ベンダー単位のみ
chunk_size>0 → ベンダー単位 + 長文の二次分割
```

### 2. 統合管理層

#### Indexer (`rag_core/indexer.py`)
**機能:**
- ファイル拡張子による自動判定（.json → JSON Loader, .md → MD Splitter）
- ディレクトリ指定時の同名ファイル優先（JSON > MD）
- ベクトルストアの自動構築・保存
- ASCIIセーフなパス生成

**優先順位:**
```
vendors.json → ベンダー調査JSON練習版.json → ベンダー調査.json → 任意.json → .md
```

#### Vectorstore (`rag_core/vectorstore.py`)
**機能:**
- FAISSベクトルストアの管理
- 永続化（.vectorstores/vendors_faiss）
- 空ドキュメントの自動除外
- フォールバック保存（指定パス失敗時）

**保存構造:**
```
.vectorstores/vendors_faiss/
├── index.faiss          # ベクトルインデックス
├── index.pkl            # メタデータ
└── docstore.pkl         # ドキュメントストア
```

### 3. アプリケーション層

#### Streamlit UI (`app_streamlit.py`)
**機能:**
- 統合インターフェース（検索UI + KBビューア + ブラウズ）
- リアルタイム設定（TopK, MMR, チャンクサイズ）
- APIキー管理（session_state > env > secrets）
- フォールバック機能（指定パス → 自動選択）

**UI構成:**
```
├── サイドバー（パラメータ設定 + データ読み込み + フィルタ）
├── タブ1: 検索UI（質問入力 → 回答生成）
├── タブ2: KBビューア（サマリ → 一覧 → 検索テスト）
└── タブ3: ブラウズ（集計 → リスト → 詳細）
```

#### RAG Chain (`rag_core/chain.py`)
**機能:**
- ベクトル検索 + LLM統合
- MMR（Maximum Marginal Relevance）による多様性確保
- スコア閾値による品質フィルタリング
- プロンプトテンプレート管理

**処理フロー:**
```
クエリ → ベクトル検索 → MMR適用 → スコアフィルタ → 文脈構築 → LLM回答
```

## 🎯 新機能：ブラウズUI

### 1. 集計カード機能
**クリック可能な集計カード:**
- **面談ステータス**: 面談済/未面談の社数
- **上場区分**: 上場/未上場の社数  
- **タイプ**: SaaS/スクラッチ/SI等の社数

**表示例:**
```
面談ステータス    上場区分        タイプ
面談済：30社     上場：15社      SaaS：20社
未面談：23社     未上場：38社    スクラッチ：25社
```

### 2. フィルタ機能
**左サイドバーのマルチセレクト:**
- 面談ステータス（複数選択）
- 上場区分（複数選択）
- タイプ（複数選択）
- 得意分野（use_cases、複数選択）
- フィルタクリアボタン

### 3. 階層的ビュー
**3段階の階層構造:**
1. **集計**: 全体の統計情報をカード表示
2. **リスト**: フィルタ条件に一致する会社一覧
3. **詳細**: 各会社の詳細情報とドキュメント内容

### 4. ドリルダウン機能
**クリックによる直感的な絞り込み:**
- 集計カードクリック → 該当条件の会社のみ表示
- 会社名クリック → 詳細情報の展開表示
- フィルタ変更 → リアルタイムで結果更新

## 🛡️ 技術的特徴

### 1. 型安全性
- **Pydanticモデル**: `Vendor`クラスでデータ構造を厳格化
- **型ヒント**: 全関数に型注釈を付与
- **バリデーション**: JSONデータの自動検証・正規化

### 2. 拡張性
- **プラグイン設計**: 新しいローダーや分割器を簡単に追加
- **設定外部化**: `config.py`でパラメータ管理
- **CLI対応**: `tools/reindex.py`でバッチ処理

### 3. ユーザビリティ
- **自動化**: ファイル選択、パス解決、エラー処理
- **視覚化**: データフレーム、メトリクス、プレビュー
- **インタラクティブ**: リアルタイム検索、動的設定変更
- **階層的UI**: 集計→リスト→詳細の直感的な操作

### 4. データ正規化
- **構造変換**: 入れ子JSONをフラットなメタデータに展開
- **欠損値処理**: 適切なデフォルト値（"不明"、"その他"等）
- **型変換**: 文字列、リスト、ブール値の適切な処理

## 📊 データ構造

### 1. 入力データ
```json
// vendors.json
{
  "vendor_id": "V-LiberCraft",
  "name": "LiberCraft",
  "engagement": {"status": "面談済"},
  "type": "スクラッチ",
  "capabilities": ["機械学習", "最適化"],
  "commercials": {"man_month_jpy": "200-300"},
  "delivery": {"deployment": "ハイブリッド"},
  "corporate": {"listed": "未上場", "investors": ["投資家A"]},
  "tags": {"use_cases": ["機械学習", "最適化"]}
}
```

### 2. 正規化後
```python
# Pydanticモデル
Vendor(
    vendor_id="V-LiberCraft",
    name="LiberCraft",
    status="面談済",
    category="スクラッチ",
    industry_tags=["機械学習", "最適化"],
    price_range="高",
    deployment="ハイブリッド"
)
```

### 3. ドキュメント化
```python
# LangChain Document
Document(
    page_content="ベンダー名: LiberCraft\nベンダーID: V-LiberCraft\n...",
    metadata={
        "vendor_id": "V-LiberCraft",
        "name": "LiberCraft",
        "status": "面談済",
        "type": "スクラッチ",
        "listed": "未上場",
        "use_cases": ["機械学習", "最適化"],
        "source_format": "json"
    }
)
```

## 🚀 使用例

### 基本的な検索
```python
# 1. データ読み込み
docs = load_documents_auto(Path("data/vendors.json"))

# 2. ベクトルストア構築
vectorstore = build_faiss(docs, embeddings=embeddings)

# 3. 検索実行
results = vectorstore.similarity_search("契約書管理", k=5)
```

### CLI使用
```bash
# 単一ファイル指定（推奨）
python tools/reindex.py --input data/vendors.json --chunk_size 0

# フォルダ指定（同名がある場合は JSON を優先）
python tools/reindex.py --input data --chunk_size 0
```

### Streamlit UI
```bash
# アプリ起動
streamlit run app_streamlit.py

# 使用手順
1. 左サイドバーの「📥 データ読み込み / 再インデックス」をクリック
2. 自動でvendors.jsonが選択され、ベンダーデータが読み込まれる
3. 検索UI、KBビューア、またはブラウズで利用可能
```

### ブラウズUI操作
```bash
# ブラウズタブでの操作例
1. 「📊 ブラウズ」タブをクリック
2. 集計カードで全体像を把握
3. 「未面談：23社」をクリック → 未面談の会社のみ表示
4. 左サイドバーで「タイプ：SaaS」を選択 → さらに絞り込み
5. 会社名をクリック → 詳細情報を確認
```

## 🔮 今後の拡張可能性

### 1. フィルタリング機能の強化
- 価格帯、従業員規模での絞り込み
- 複数条件の組み合わせ検索
- 保存されたフィルタ設定

### 2. 再ランク機能
- LLMによる検索結果の再順位付け
- ユーザー意図に基づく結果調整
- 学習型ランキング

### 3. マルチモーダル対応
- 画像、PDF等の他形式対応
- 音声データの処理
- 動画コンテンツの分析

### 4. API化
- REST APIとして外部システム連携
- GraphQL対応
- リアルタイム更新機能

### 5. バッチ処理
- 大量データの効率的な処理
- 分散処理対応
- スケジューリング機能

### 6. ブラウズUIの拡張
- エクスポート機能（CSV、Excel）
- 比較機能（複数ベンダーの並列表示）
- ダッシュボード機能（グラフ、チャート）

## 📋 設定パラメータ

### 検索パラメータ
- **TopK**: 取得文書数（1-15、既定8）
- **MMR**: 多様性確保の有無
- **スコア閾値**: 品質フィルタリング
- **チャンクサイズ**: テキスト分割サイズ（0=無効化）

### モデル設定
- **Embedding**: text-embedding-3-small（固定）
- **LLM**: GPT-4（設定可能）
- **Temperature**: 0.0（固定）

### パス設定
- **データディレクトリ**: data/
- **ベクトルストア**: .vectorstores/vendors_faiss/
- **プロンプト**: prompts/answer_prompt.md

### ブラウズUI設定
- **集計表示**: 面談ステータス、上場区分、タイプ
- **フィルタ項目**: ステータス、上場、タイプ、得意分野
- **ソート順**: 面談済を上位、名前順

## 🔧 トラブルシューティング

### よくある問題
1. **APIキー未設定**: サイドバーでAPIキーを入力
2. **ファイル未検出**: data/にvendors.jsonを配置
3. **メモリ不足**: チャンクサイズを調整
4. **検索精度**: TopKやMMRを調整
5. **ブラウズ表示異常**: メタデータの欠損を確認

### ログ確認
- Streamlit: ブラウザの開発者ツール
- CLI: 標準出力
- エラー: 詳細なスタックトレース表示

### パフォーマンス最適化
- **大量データ**: チャンクサイズを0に設定
- **検索速度**: TopKを適切に調整
- **メモリ使用量**: 不要なメタデータを削除

---

このシステムは、ベンダー調査データの効率的な検索・分析・分類を目的とした、実用的で拡張性の高いRAGアーキテクチャを提供しています。検索、分析、ブラウズの3つの機能を統合し、ユーザーの様々なニーズに対応できる包括的なソリューションとなっています。