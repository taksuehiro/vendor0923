引き継ぎ書（vendor0919 プロジェクト）
1. 要約（TL;DR）

現状：ECS(Fargate) バックエンドは ALB 経由で稼働、/docs で Swagger UI が見える。

最新タスク定義：vendor0919-task:11（CloudWatch Logs 出力設定済み）。

ALB DNS：http://vendor0919-alb-new-619968933.ap-northeast-1.elb.amazonaws.com

次アクション：Amplify の環境変数に上記 ALB を設定 → 再デプロイ → フロントから API 動作確認。

確認用：curl /docs が 200 OK、curl / は FastAPI 仕様で 404 Not Found（正常）。

2. インフラ構成（把握している範囲）

リージョン：ap-northeast-1

CodeBuild プロジェクト：vendor0919（buildspec.yml を参照するよう修正済み）

ECR リポジトリ：vendor0919-api（例タグ：202509250200 / latest）

ECS：

クラスタ：vendor0919-cluster

サービス：vendor0919-service

タスク定義 family：vendor0919-task（最新 :11）

コンテナ名：api（ポート 8080/tcp）

ALB / TG：

ALB 名：vendor0919-alb-new

DNS：vendor0919-alb-new-619968933.ap-northeast-1.elb.amazonaws.com

TargetGroup：vendor0919-tg-new（ARN 末尾 /1082e69f886174a0）

S3（RAG ベクターストア）：

バケット：vendor-rag-0919

プレフィックス：vectorstore/prod

ローカル格納先（コンテナ内）：/app/vectorstore

ログ：

CloudWatch Logs グループ：/ecs/vendor0919-api（タスク定義 :11 より有効）

IAM：

CodeBuild ロール：codebuild-vendor0919-service-role

付与ポリシー：AmazonEC2ContainerRegistryPowerUser

3. 直近の状態確認コマンド（コピペOK）
# 共通
export REGION=ap-northeast-1

# CodeBuild 最終ビルド
aws codebuild list-builds-for-project --project-name vendor0919 --region "$REGION" --max-items 1
# ECR タグ一覧
aws ecr list-images --repository-name vendor0919-api --region "$REGION" --query 'imageIds[].imageTag' --output table

# ECS サービス・デプロイ状態
aws ecs describe-services --cluster vendor0919-cluster --services vendor0919-service --region "$REGION" --query 'services[0].{taskDef:taskDefinition,deployments:deployments}'

# 実行中タスクと詳細
TASK_ARN=$(aws ecs list-tasks --cluster vendor0919-cluster --service-name vendor0919-service --region "$REGION" --query 'taskArns[0]' --output text)
aws ecs describe-tasks --cluster vendor0919-cluster --tasks "$TASK_ARN" --region "$REGION" --query 'tasks[0].{def:taskDefinitionArn,status:lastStatus,containers:containers[*].{name:name,lastStatus:lastStatus}}'

# ALB 疎通確認
curl -i http://vendor0919-alb-new-619968933.ap-northeast-1.elb.amazonaws.com/docs

4. デプロイ手順（ECR → ECS）※汎用テンプレ

前提：IMAGE_TAG は CodeBuild で push 済みの日時タグ等。

export REGION=ap-northeast-1
export IMAGE_TAG=202509250200   # 例：最新タグに置換

# 1) 現タスク定義を取得
aws ecs describe-task-definition \
  --task-definition vendor0919-task \
  --region "$REGION" \
  --query 'taskDefinition' >/tmp/taskdef.json

# 2) 登録不可フィールドを削除
jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
  /tmp/taskdef.json >/tmp/taskdef.cleaned.json

# 3) 画像タグを置換
jq --arg tag "$IMAGE_TAG" '.containerDefinitions[0].image |= sub(":[^:]+$"; ":" + $tag)' \
  /tmp/taskdef.cleaned.json >/tmp/taskdef.tagged.json

# 4) CloudWatch Logs 出力を保証（未設定の場合は上書き）
jq '.containerDefinitions[0].logConfiguration = {
  "logDriver": "awslogs",
  "options": {
    "awslogs-group": "/ecs/vendor0919-api",
    "awslogs-region": "ap-northeast-1",
    "awslogs-stream-prefix": "ecs"
  }
}' /tmp/taskdef.tagged.json >/tmp/taskdef.new.json

# 5) タスク定義を新規登録（新しいリビジョンが払い出される）
aws ecs register-task-definition \
  --cli-input-json file:///tmp/taskdef.new.json \
  --region "$REGION"

# 6) サービスを新リビジョンへ更新（最新に差し替え）
# 直前の出力で得た新リビジョン番号に置換（例: :12）
aws ecs update-service \
  --cluster vendor0919-cluster \
  --service vendor0919-service \
  --task-definition vendor0919-task:12 \
  --force-new-deployment \
  --region "$REGION"

# 7) 収束確認
aws ecs describe-services \
  --cluster vendor0919-cluster \
  --services vendor0919-service \
  --region "$REGION" \
  --query 'services[0].deployments'

5. Amplify（フロント）連携 TODO

環境変数の設定（例）

NEXT_PUBLIC_API_BASE=http://vendor0919-alb-new-619968933.ap-northeast-1.elb.amazonaws.com

認証を使う場合は NEXTAUTH_URL/NEXTAUTH_SECRET 等も同期

CORS 設定（FastAPI 側）
Amplify の URL（https://<branch>.<id>.amplifyapp.com）を許可に追加。
例（FastAPI 側）：

from fastapi.middleware.cors import CORSMiddleware
origins = [
    "http://localhost:3000",
    "https://<your-amplify-domain>.amplifyapp.com",
]
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


動作確認

フロント → API の主要フローを実行

401/403 が出る場合は Cookie/Session/ドメイン設定を確認

6. ALB ヘルスチェック（必要に応じて）

現在 / へのアクセスは 404（正常挙動）。ヘルスチェックも / のままだと不安定な場合は /health に変更推奨。
ヘルスエンドポイントが未実装なら、以下を FastAPI に追加：

from fastapi import FastAPI
app = FastAPI()
@app.get("/health")
def health():
    return {"status":"ok"}


ターゲットグループのヘルスチェックパス変更：

aws elbv2 modify-target-group \
  --target-group-arn arn:aws:elasticloadbalancing:ap-northeast-1:067717894185:targetgroup/vendor0919-tg-new/1082e69f886174a0 \
  --health-check-path /health \
  --region "$REGION"

7. よくあるトラブルと対処

CodeBuild で ECR ログイン失敗
→ CodeBuild ロールに AmazonEC2ContainerRegistryPowerUser を付与済みか確認

ECS デプロイ後に旧リビジョンのまま
→ --task-definition vendor0919-task:<新> を明示して update-service

タスクが STOPPED（exitCode:1）
→ CloudWatch Logs（/ecs/vendor0919-api）で起動エラー内容を確認（環境変数/Secrets/ポート/モジュール）

ALB から 5xx
→ ターゲットヘルス、SG/サブネット、コンテナポート(8080) を確認

8. 便利スクリプト（作成コマンドつき）
scripts/deploy_ecr_to_ecs.sh
mkdir -p scripts
cat > scripts/deploy_ecr_to_ecs.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
REGION="${REGION:-ap-northeast-1}"
FAMILY="vendor0919-task"
CLUSTER="vendor0919-cluster"
SERVICE="vendor0919-service"
IMAGE_TAG="${IMAGE_TAG:?export IMAGE_TAG=<ecr tag>}"

aws ecs describe-task-definition --task-definition "$FAMILY" --region "$REGION" --query 'taskDefinition' >/tmp/taskdef.json
jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
  /tmp/taskdef.json >/tmp/taskdef.cleaned.json
jq --arg tag "$IMAGE_TAG" '.containerDefinitions[0].image |= sub(":[^:]+$"; ":" + $tag)' \
  /tmp/taskdef.cleaned.json >/tmp/taskdef.tagged.json
jq '.containerDefinitions[0].logConfiguration = {
  "logDriver": "awslogs",
  "options": {
    "awslogs-group": "/ecs/vendor0919-api",
    "awslogs-region": "ap-northeast-1",
    "awslogs-stream-prefix": "ecs"
  }
}' /tmp/taskdef.tagged.json >/tmp/taskdef.new.json

NEW_ARN=$(aws ecs register-task-definition --cli-input-json file:///tmp/taskdef.new.json --region "$REGION" --query 'taskDefinition.taskDefinitionArn' --output text)
echo "Registered: $NEW_ARN"

aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" --task-definition "$NEW_ARN" --force-new-deployment --region "$REGION" >/dev/null
echo "Service update started."

aws ecs describe-services --cluster "$CLUSTER" --services "$SERVICE" --region "$REGION" --query 'services[0].deployments'
EOF
chmod +x scripts/deploy_ecr_to_ecs.sh


実行例：

export IMAGE_TAG=202509250200
bash scripts/deploy_ecr_to_ecs.sh

9. 参考エンドポイント

GET /docs（Swagger UI：稼働確認済み）

GET /health（任意実装）

GET / は 404（FastAPI 既定どおり）

10. 連絡事項

すでに ALB→ECS→アプリは動作。残タスクは Amplify 側の環境変数設定とフロントからの疎通。

Secrets や CORS はフロントドメイン確定後に最終調整予定。

監視のアラーム（低 CPU 利用率）はスケール設定用で、現時点は無害。

必要になれば、この引き継ぎ書を Docs/引き継ぎ_vendor0919.md としてコミットするためのコマンドも用意します。欲しければ言ってください。引き続きスムーズに進められるはずです！