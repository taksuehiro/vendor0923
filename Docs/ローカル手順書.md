ローカル開発書（Next.js 専用 / FastAPI → Git 経由で AWS）

方針宣言：ローカルも本番も UI は Next.js に統一します（Streamlit は使用しません）。本書は Next.js ↔ FastAPI のみで疎通・検証できるように再整理した最終版です。

0. ローカル開発アーキテクチャ（確定）
┌──────────────────────────────────────────────────────────────────────────┐
│                                Local Developer Machine                   │
│                                                                          │
│  ┌──────────────┐        JSON/HTTPS        ┌──────────────┐             │
│  │  Next.js FE  │  ─────────────────────▶  │  FastAPI BE  │             │
│  │  (AppRouter) │  ◀─────────────────────  │  (Uvicorn)   │             │
│  └─────┬────────┘     /auth/verify 等       └──────┬───────┘             │
│        │  fetch(API_BASE)                            │                   │
│        │                                             │                   │
│   認証: NextAuth (Credentials)                 Vectorstore: FAISS        │
│   - NEXTAUTH_URL=http://localhost:3000         - ./vectorstores/...     │
│   - NEXT_PUBLIC_API_BASE=http://127.0.0.1:8000 原データ: ./data/*.json    │
│   - NEXTAUTH_SECRET=dev-secret                                          │
│                                                                          │
│  補助: CLI reindex（任意、開発者用）                                     │
└──────────────────────────────────────────────────────────────────────────┘


> 将来の持ち上げ先：FE→Amplify Hosting／BE→ECS(Fargate)+ALB／Vectorstore→EFS／原データ→S3（OpenAI は外部）。


---


## 1. 開発スタック / ディレクトリ規約
- **Frontend**: Next.js (TypeScript, App Router), Tailwind, shadcn/ui, NextAuth(Credentials)
- **Backend**: FastAPI (Python 3.11), Uvicorn, SQLAlchemy（任意）, Pydantic, CORS, python-jose
- **Vectorstore**: FAISS（ローカルは FS、`./vectorstores/vendors_faiss`）
- **データ**: `./data/vendors.json`（秘匿が必要なら `.gitignore`）
- **構成例**

repo/ frontend/ # Next.js backend/ # FastAPI data/ # 入力データ（ローカル） vectorstores/ # FAISS（ローカル） scripts/ # reindex など（任意）



---


## 2. 環境変数（ローカル）
| 変数 | 用途 | 推奨値（dev） |
|---|---|---|
| NEXT_PUBLIC_API_BASE | FE→BE 呼出先 | `http://127.0.0.1:8000` |
| NEXTAUTH_URL | NextAuth 自己 URL | `http://localhost:3000` |
| NEXTAUTH_SECRET | FE/BE 共通シークレット | `dev-<十分に長い乱数>` |
| DATABASE_URL | 任意（使う場合） | `sqlite+aiosqlite:///./backend/dev.db` |
| VECTOR_DIR | FAISS 保存先 | `./vectorstores/vendors_faiss` |
| ALLOWED_ORIGINS | CORS 許可 | `http://localhost:3000` |


> 保存場所：`frontend/.env.local` と `backend/.env`。**本番は Amplify/SSM/Secrets** に移行。


---


## 3. 初期化手順（1回だけ）
### 3.1 Frontend（Next.js）
```bash
npx create-next-app@latest frontend --ts --eslint
cd frontend
npm i -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
# tailwind.config.* の content に ./app/**/*, ./src/**/* を追加
# app/globals.css に @tailwind base; @tailwind components; @tailwind utilities;


# shadcn/ui（必要な分のみ）
npx shadcn-ui@latest init
npx shadcn-ui@latest add button input label card toast skeleton


# NextAuth（Credentials）: app/api/auth/[...nextauth]/route.ts を作成
# middleware.ts で /dashboard を保護

frontend/.env.local を作成：

NEXT_PUBLIC_API_BASE=http://127.0.0.1:8000
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=dev-xxxxxxxxxxxxxxxx
3.2 Backend（FastAPI）
cd ../backend
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install fastapi uvicorn[standard] pydantic[email] sqlalchemy aiosqlite alembic \
            passlib[bcrypt] python-dotenv python-jose[cryptography] python-multipart faiss-cpu

backend/.env を作成：

NEXTAUTH_SECRET=dev-xxxxxxxxxxxxxxxx
VECTOR_DIR=./vectorstores/vendors_faiss
DATABASE_URL=sqlite+aiosqlite:///./backend/dev.db
ALLOWED_ORIGINS=http://localhost:3000

backend/main.py の要件：

/health = 200

CORS: allow_origins=[ALLOWED_ORIGINS], allow_credentials=True

POST /auth/verify（Credentials を受けて 200/401）

GET /me（JWT 検証）

POST /search（まずはモック 200）

4. 起動と疎通（E2E）

バックエンド起動

cd backend
uvicorn main:app --reload --port 8000
# curl 127.0.0.1:8000/health → {"status":"ok"}

フロントエンド起動

cd frontend
npm run dev
# http://localhost:3000 を開く

ログイン→保護画面

/login → Credentials サインイン → /dashboard

失敗: 401、成功: セッション確立

API テスト

/me が 200（JWT）

/search が 200（モックで可）

Tips: Cookie 必要な fetch は { credentials: 'include' }。CORS は allow_credentials=True。

5. Vectorstore とデータ（ローカル）

原データ: ./data/vendors.json（必要に応じて .gitignore）

再インデックス: scripts/reindex.py（任意）→ VECTOR_DIR に FAISS を出力

BE 読込: /search が VECTOR_DIR を参照（未作成時の挙動は自動構築 or 404 を選択）

6. API 契約（最小）

POST /auth/verify

{ "email": "string", "password": "string" }

200: { id, email, org_id }

401: { detail: "Invalid credentials" }

GET /me

Header: Authorization: Bearer <jwt> → 200 { id, email }

POST /search（モック）

{ "query": "string", "top_k": 5, "mmr": 0.5 }

200: { hits: [ { id, title, score, snippet } ] }

7. Git & ブランチ運用
git init
git checkout -b feature/frontend-aws-migration
git add . && git commit -m "feat: init local FE/BE"

feature/*: 開発用

staging: Amplify Preview 用（本番同等チェック）

main: 本番

CI: Node v20 固定、npm ci→npm run build。BE は将来 Docker 化（ポート 8080 前提）。

8. トラブルシューティング
症状	よくある原因	対処
422 Unprocessable Entity	FastAPI がクエリ/フォーム受け	Pydantic モデルで JSON body を受ける
401 Unauthorized	SECRET 不一致 / Cookie 未送信	NEXTAUTH_SECRET を FE/BE で一致 / credentials:'include'
CORS エラー	allow_origins と credentials の不整合	ALLOWED_ORIGINS に FE URL を設定 + allow_credentials=True
404（Next.js）	App Router 配置ミス	app/(auth)/login/page.tsx、middleware.ts の対象確認
9. AWS への持ち上げ準備（覚え書き）

Amplify: monorepo 向け amplify.yml（appRoot: frontend, Node v20）/ ブランチ別に NEXT_PUBLIC_API_BASE & NEXTAUTH_URL

ECS(Fargate): BE の Docker 化（EXPOSE 8080・/health）→ ALB ヘルスチェック /health

EFS/S3: VECTOR_DIR は EFS、原データは S3

Secrets: NEXTAUTH_SECRET 等は Secrets Manager/SSM（FE はビルド時のみ最小利用）

切替: Amplify の Production branch 昇格 or ドメイン割当スワップ

10. 完了条件（ローカル）




注意：Streamlit 関連のスクリプト/依存は使いません（残骸がある場合は削除 or 無効化）。

了解です。ローカルも Next.js に統一する前提で、手順書を矛盾なしの最終版に書き直しました（キャンバス更新済み）。