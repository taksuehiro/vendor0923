ローカル開発書（アーキテクチャ確定版 / Next.js + FastAPI → Git 経由で AWS）

目的：ローカル環境で“本番を見据えたミニ構成”を再現し、フロント/バックを疎通させたうえで Git に載せ、既存 AWS 構成へシームレスに持ち上げられる状態にする。 Blue/Green は使わず、Amplify のブランチ昇格/ドメイン割当スワップで軽量に切替る方針。

0. ローカル開発アーキテクチャ（今回の確定像）
┌──────────────────────────────────────────────────────────────────────────┐
│                                Local Developer Machine                   │
│                                                                          │
│  ┌──────────────┐        JSON/HTTPS        ┌──────────────┐             │
│  │  Next.js FE  │  ─────────────────────▶  │  FastAPI BE  │             │
│  │  (AppRouter) │  ◀─────────────────────  │  (Uvicorn)   │             │
│  └─────┬────────┘     /auth/verify 等       └──────┬───────┘             │
│        │  fetch(API_BASE)                            │                   │
│        │                                             │                   │
│   認証: NextAuth (Credentials)                 Vectorstore: FAISS        │
│   - NEXTAUTH_URL=http://localhost:3000         - ローカルFSに保存        │
│   - NEXT_PUBLIC_API_BASE=http://127.0.0.1:8000  - ./vectorstores/...     │
│   - NEXTAUTH_SECRET=dev-secret                 原データ: ./data/*.json    │
│                                                                          │
│  補助: CLI reindex（任意） → BE 経由 or 直接 FS 書込                      │
└──────────────────────────────────────────────────────────────────────────┘


将来持ち上げ先（参照）：FE→Amplify Hosting／BE→ECS(Fargate)+ALB／Vectorstore→EFS／原データ→S3（OpenAI は外部のまま）。


---


## 1. 開発スタック / ディレクトリ規約
- **Frontend**: Next.js (TypeScript, App Router), Tailwind, shadcn/ui, NextAuth(Credentials)
- **Backend**: FastAPI (Python 3.11), Uvicorn, SQLAlchemy（必要なら）, Pydantic, CORS, python-jose
- **Vectorstore**: FAISS（ローカルはファイルシステム、`./vectorstores/vendors_faiss`）
- **データ**: `./data/vendors.json` など（ローカルでは Git 管理 or .gitignore 適用を選択）
- **構成例**

repo/ frontend/ # Next.js backend/ # FastAPI data/ # 入力データ（ローカル） vectorstores/ # FAISS（ローカル） scripts/ # reindex など（任意）



---


## 2. 環境変数（ローカル）
| 変数 | 用途 | 推奨値（dev） |
|---|---|---|
| NEXT_PUBLIC_API_BASE | FE→BE の呼出先 | `http://127.0.0.1:8000` |
| NEXTAUTH_URL | NextAuth の自己 URL | `http://localhost:3000` |
| NEXTAUTH_SECRET | FE/BE 共通シークレット | `dev-<十分に長い乱数>` |
| DATABASE_URL | 任意（使う場合） | `sqlite+aiosqlite:///./backend/dev.db` |
| VECTOR_DIR | FAISS の保存先 | `./vectorstores/vendors_faiss` |


> ローカルでは `frontend/.env.local` と `backend/.env` に分けて保存。**本番は Amplify/SSM/Secrets** に移す前提。


---


## 3. 初期化手順（一度だけ）
### 3.1 Frontend（Next.js）
```bash
npx create-next-app@latest frontend --ts --eslint
cd frontend
npm i -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
# tailwind.config.* の content に ./app/**/*, ./src/**/* を追加
# app/globals.css に @tailwind base; @tailwind components; @tailwind utilities;


# shadcn/ui（必要なものだけ）
npx shadcn-ui@latest init
npx shadcn-ui@latest add button input label card toast skeleton


# NextAuth（Credentials）: app/api/auth/[...nextauth]/route.ts を作成
# middleware.ts で /dashboard を保護

frontend/.env.local を作成：

NEXT_PUBLIC_API_BASE=http://127.0.0.1:8000
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=dev-xxxxxxxxxxxxxxxx
3.2 Backend（FastAPI）
cd ../backend
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install fastapi uvicorn[standard] pydantic[email] sqlalchemy aiosqlite alembic \
            passlib[bcrypt] python-dotenv python-jose[cryptography] python-multipart faiss-cpu

backend/.env を作成：

NEXTAUTH_SECRET=dev-xxxxxxxxxxxxxxxx
VECTOR_DIR=./vectorstores/vendors_faiss
DATABASE_URL=sqlite+aiosqlite:///./backend/dev.db
ALLOWED_ORIGINS=http://localhost:3000

backend/main.py の要件：

/health が 200 を返す

CORS: allow_origins=[ALLOWED_ORIGINS], allow_credentials=True

POST /auth/verify（Credentials を受けて 200/401）

GET /me（JWT 検証）

POST /search（まずはダミーで 200）

4. 起動と疎通（E2E）

バックエンド起動

cd backend
uvicorn main:app --reload --port 8000
# curl 127.0.0.1:8000/health → {"status":"ok"}

フロントエンド起動

cd frontend
npm run dev
# http://localhost:3000 を開く

ログイン→保護画面

/login → Credentials でサインイン → /dashboard に遷移

失敗時は 401、成功時はセッションが確立

API テスト

/me で JWT が通ること

/search が 200 を返すこと（最初はモック応答で可）

Tips: Cookie を使うパスは fetch(..., { credentials: 'include' }) を付与。CORS も allow_credentials=True を維持。

5. Vectorstore とデータ（ローカル）

原データ: ./data/vendors.json（例）。編集頻度が高いなら Git 管理、秘匿が要るなら .gitignore 推奨。

再インデックス: scripts/reindex.py（任意）を用意し、VECTOR_DIR に FAISS を出力。

BE 実行時読込: /search で VECTOR_DIR を参照。インデックス未作成時は自動構築 or 404 を返す方針を選択。

6. API 契約（最小）

POST /auth/verify

{ "email": "string", "password": "string" }

200: { id, email, org_id }

401: { detail: "Invalid credentials" }

GET /me

Header: Authorization: Bearer <jwt> → 200 { id, email }

POST /search（当面モック）

{ "query": "string", "top_k": 5, "mmr": 0.5 }

200: { hits: [ { id, title, score, snippet } ] }

7. Git への載せ方 & ブランチ運用
cd repo
git init
git checkout -b feature/frontend-aws-migration
git add . && git commit -m "feat: init local FE/BE"

feature/*: 開発用

staging: Amplify Preview 用（本番同等チェック）

main: 本番

CI では Node v20 固定、npm ci → npm run build。バックエンドは将来 Docker 化（コンテナポート 8080 を前提）。

8. トラブルシューティング
症状	よくある原因	対処
422 Unprocessable Entity	FastAPI がクエリ/フォームで受けている	Pydantic モデルで JSON body を受ける
401 Unauthorized	SECRET 不一致 / Cookie 未送信	NEXTAUTH_SECRET を FE/BE で揃える / credentials:'include'
CORS エラー	allow_origins と credentials の不整合	http://localhost:3000 を ALLOWED_ORIGINS に入れ、allow_credentials=True
404（Next.js ルーティング）	App Router の配置ミス	app/(auth)/login/page.tsx 等のパス確認、middleware.ts の対象パス確認
9. AWS 持ち上げ前提の差分（覚え書き）

Amplify: monorepo 向け amplify.yml（appRoot: frontend, Node v20, npm ci → npm run build）/ ブランチ別に NEXT_PUBLIC_API_BASE & NEXTAUTH_URL を設定

ECS(Fargate): BE を Docker 化（EXPOSE 8080・/health）、ALB ターゲットのヘルスチェックパス=/health

EFS/S3: VECTOR_DIR は EFS、原データは S3（起動時同期 or 直接参照）

Secrets: NEXTAUTH_SECRET などは Secrets Manager/SSM に置き、FE はビルド時のみ最小利用

切替運用: Amplify の Production branch 昇格 か ドメイン割当スワップ（ロールバック容易）



10. 受入チェックリスト（ローカル完了条件）




この文書は“ローカル段階の最終版”。以降、実リポジトリ/ドメイン/アカウント情報が出揃い次第、Amplify 用 amplify.yml と ECS タスク定義の雛形を追補してそのまま本番へ昇格可能です。