🔎 本スレッドまとめ

API Gateway / CORS 問題

$default ステージでは古い統合が残っていて、503 や CORS エラーが頻発。

新規に prod ステージを作成し、ANY /{proxy+} ルートを ALB に接続。

OPTIONS ルートを追加し、CORS ヘッダーが安定的に返るようになった。

結果として curl / ブラウザ双方で CORS 問題は解消。

ECS / ECR デプロイ問題

vendor0919 リポジトリからビルドしたコンテナには rag_core.py が存在せず、ImportError が発生。

ログで attempted relative import with no known parent package が確認され、コードベースの不一致が発覚。

GitHub で確認すると rag_core.py は vendor0923 にのみ存在。
→ ECS は vendor0919 を参照しており、最新コードが反映されていなかった。

リポジトリ不一致の本質

現在稼働中の ECS は vendor0919 をベースに運用。

修正内容は vendor0923 に push 済み。

つまり 本番と GitHub 修正先が乖離 していた。

✅ 今後の方針（vendor0923 切り替え）
1. ECR を vendor0923 ベースにする

vendor0923/backend のソースで docker build。

ECR (vendor0919-backend) の latest タグを更新。

aws ecs update-service --force-new-deployment で差し替え。

👉 こうすることで ECS が vendor0923 のコードで稼働し、rag_core.py や rag_core_s3.py が正しく読み込まれる。

2. Amplify / API Gateway はそのまま活かす

Amplify の環境変数は NEXT_PUBLIC_API_BASE=https://.../prod のままで OK。

API Gateway は prod ステージ + CORS 設定が安定して動いているので、触る必要なし。

3. 今後の運用ルール

本番用リポジトリを vendor0923 に統一。

vendor0919 はアーカイブ扱いにし、参照しないようにする。

ECS/ECR のビルド元も必ず vendor0923 にする。

Amplify (フロント) も vendor0923 と連動させ、整合性を保つ。

📌 明日の作業ステップ

vendor0923/backend から docker build -t vendor0919-backend:latest .

docker push 067717894185.dkr.ecr.ap-northeast-1.amazonaws.com/vendor0919-backend:latest

aws ecs update-service --force-new-deployment で再デプロイ

CloudWatch Logs で OPENAI_API_KEY loaded: True になるか確認

ブラウザから /search を叩いて動作検証