プロジェクト状況サマリ（2025-09-24）
目的

FAISS ベクトルDBの永続化を ECS ローカル → S3 保存＆ロードに移行

将来は CodePipeline/CodeBuild で自動ビルド＆デプロイへ（現状は手動）

今日やったこと（実績）
インフラ確認・整備

ALB / ECS / TG の特定

ALB: vendor0919-alb-new

ALB DNS: vendor0919-alb-new-619968933.ap-northeast-1.elb.amazonaws.com

TG: arn:aws:elasticloadbalancing:ap-northeast-1:067717894185:targetgroup/vendor0919-tg-new/1082e69f886174a0

Target health = healthy（ALB→ECS 経路は良好）

VPC/SG/Subnet

VPC: vpc-0484f20452b5a7773

ALB SG: sg-0fa3ee4b2af769436（:80 全世界許可）※vendor0919専用

ALB Subnets: subnet-0d9d1c034ff3310ca, subnet-0fad2d28b04a7e2b5

同サブネットに VPC Endpoint の ENI あり → 共用のため削除注意

S3 バケット作成

vendor-rag-0919 / vectorstore/prod

Block Public Access 全有効、Versioning 有効、SSE-S3 (AES256) 有効

ECS タスク定義の環境変数追加

VECTORSTORE_S3_BUCKET=vendor-rag-0919

VECTORSTORE_S3_PREFIX=vectorstore/prod

VECTORSTORE_LOCAL_DIR=/app/vectorstore

タスクロールに最小権限ポリシー付与

S3VectorstoreAccess（ListBucket/Put/Get/Copy を bucket/prefix に限定）

Secrets Manager

arn:aws:secretsmanager:ap-northeast-1:067717894185:secret:vendor0913/openai/config

OPENAI_API_KEY ほか格納（値は参照不可・ECS から valueFrom で取得）

アプリ／デプロイ関連

ECR リポジトリ: vendor0919-api

CodeBuild プロジェクト: vendor0919（ソース：GitHub taksuehiro/vendor0923）

buildspec.yml をリポジトリ直下に作成・push

しかし CodeBuild 側が “インライン buildspec” のままで実行 → ビルド失敗

CodeBuild 手動実行を複数回トライ（設定誤りのため ECR に新タグ増えず）

ECR 現状のタグ: 202509240319, 202509240325, latest

ECS 実行中イメージ: .../vendor0919-api:202509240325（反映済み）

/health 応答: {"status":"ok"}（vectorstore_source 未出力）

S3: s3://vendor-rag-0919/vectorstore/prod/current/ は 空

いまの状態（まとめ）

インフラ側の前提（S3・IAM・環境変数）は揃った。

アプリの S3 対応コードは main に入っているが、ログ出力や /health 拡張が反映されていない可能性。

CodeBuild が正しい buildspec.yml を使っていないため、新しい日時タグのイメージが ECR に増えていない。

その結果、S3 保存＆ロードの動作確認が未完了。

残課題（Blocking）

CodeBuild 設定ミス

現在：プロジェクトが “インライン buildspec” を参照

あるべき：“buildspec ファイルを使用する（ソースの buildspec.yml）” に変更

Webhook/自動トリガは未設定（手動 start-build でOK、将来 CodePipeline）

CloudWatch Logs 未設定

タスク定義 logConfiguration=null

S3 への save/load、boto3 エラーの可視化ができない

/health の詳細出力

vectorstore_source（rebuilt->S3/current / S3/current など）を返す実装が未確認

HTTPS 化

ACM 証明書は 独自ドメインが必要。ALB DNS では発行不可

Route53 でドメイン取得 or 既存配布ドメインの割当が必要

:80 → :443 リダイレクト設定（リスナー＆ルール）を後で実施

明日やること（詳細手順）
A. CodeBuild を正しく動かす

CodeBuild 設定変更（コンソール）

プロジェクト vendor0919 → 編集

Buildspec = 「buildspec ファイルを使用」 に切替

ファイル名：buildspec.yml（リポジトリ直下）

保存

手動ビルド実行

aws codebuild start-build --project-name vendor0919 --region ap-northeast-1


ECR 新タグ確認

aws ecr list-images --repository-name vendor0919-api --region ap-northeast-1 \
  --query 'imageIds[].imageTag' --output table


→ 新しい YYYYMMDDHHMM タグが出ること

参考：buildspec.yml（使っているもの）

version: 0.2
env:
  variables:
    AWS_DEFAULT_REGION: ap-northeast-1
    REPO_NAME: vendor0919-api
phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION \
        | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - IMAGE_TAG=$(date +%Y%m%d%H%M)
      - REPO_URI=$ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME
  build:
    commands:
      - echo Build started on `date`
      - docker build -t $REPO_URI:$IMAGE_TAG backend
  post_build:
    commands:
      - echo Build completed on `date`
      - docker push $REPO_URI:$IMAGE_TAG
      - echo Writing image definitions file...
      - printf '[{"name":"api","imageUri":"%s"}]' $REPO_URI:$IMAGE_TAG > imagedefinitions.json
artifacts:
  files: imagedefinitions.json

B. 新タグを ECS に反映（手動）
REGION=ap-northeast-1
CLUSTER=vendor0919-cluster
SERVICE=vendor0919-service
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
ECR_REPO=vendor0919-api
IMAGE_TAG=<ECRで増えた新タグ>
NEW_IMAGE="$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG"

TD=$(aws ecs describe-services --cluster "$CLUSTER" --services "$SERVICE" --region "$REGION" \
  --query 'services[0].taskDefinition' --output text)

aws ecs describe-task-definition --task-definition "$TD" --region "$REGION" \
  --query 'taskDefinition' >/tmp/td.json

jq --arg IMG "$NEW_IMAGE" '
  del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy) |
  .containerDefinitions |= map(.image = $IMG)
' /tmp/td.json >/tmp/td.new.json

NEW_TD_ARN=$(aws ecs register-task-definition --cli-input-json file:///tmp/td.new.json \
  --region "$REGION" --query 'taskDefinition.taskDefinitionArn' --output text)

aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" \
  --task-definition "$NEW_TD_ARN" --force-new-deployment --region "$REGION"

C. CloudWatch Logs を有効化（強く推奨）
# 現タスク定義を取得
aws ecs describe-task-definition --task-definition "$NEW_TD_ARN" --region "$REGION" \
  --query 'taskDefinition' >/tmp/td.logs.json

# ログ設定を注入（ロググループ /ecs/vendor0919, prefix ecs）
jq --arg RG "$REGION" '
  del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy) |
  .containerDefinitions |= map(
    .logConfiguration = {
      logDriver: "awslogs",
      options: {
        "awslogs-group": "/ecs/vendor0919",
        "awslogs-region": $RG,
        "awslogs-stream-prefix": "ecs"
      }
    }
  )
' /tmp/td.logs.json >/tmp/td.logs.new.json

LG=/ecs/vendor0919
aws logs create-log-group --log-group-name $LG --region "$REGION" 2>/dev/null || true

TD_LOGS=$(aws ecs register-task-definition --cli-input-json file:///tmp/td.logs.new.json \
  --region "$REGION" --query 'taskDefinition.taskDefinitionArn' --output text)

aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" \
  --task-definition "$TD_LOGS" --force-new-deployment --region "$REGION"


確認

aws logs tail /ecs/vendor0919 --since 10m --follow --region "$REGION"


期待ログ例：

boto3 ...

FAISS rebuilt from vendors.json

uploaded to s3://vendor-rag-0919/vectorstore/prod/...

promoted to current/

D. S3 保存のトリガ（必要なら強制）

コードが「vendors.json が新しいときのみ再構築」なら、微修正して commit/push でOK

例（cat で上書き）：

cat > vendors.json <<'EOF'
{ "vendors": [ { "id": "001", "name": "ベンダーA" },
               { "id": "002", "name": "ベンダーB (updated)" } ] }
EOF
git add vendors.json && git commit -m "feat: trigger vectorstore rebuild" && git push

E. 動作確認（最終）
ALB_DNS=vendor0919-alb-new-619968933.ap-northeast-1.elb.amazonaws.com

curl -s "http://$ALB_DNS/health" | jq .
# 期待（初回）: {"status":"ok","vectorstore_source":"rebuilt->S3/current"}
# 以降: {"status":"ok","vectorstore_source":"S3/current"}

aws s3 ls "s3://vendor-rag-0919/vectorstore/prod/current/" --region "$REGION"
# 期待: index.faiss / index.pkl 等が出現

中期タスク（HTTPS/運用）

HTTPS 化

Route53 で独自ドメイン取得（or 既存配布ドメイン割当）

ACM で証明書発行 → ALB :443 リスナー作成

:80 リスナーを redirect → 443 に変更

CI/CD 自動化（推奨）

CodePipeline: GitHub → CodeBuild → ECS デプロイ（imagedefinitions.json）

main push で自動反映

セキュリティ/運用

Secrets Manager 管理の継続（OpenAI Key など）

S3 バケットのライフサイクル（古い世代のクリーンアップ）

監視：CloudWatch アラーム（5xx、タスク失敗、ディスク異常）

いま保存しておくべき固定情報
REGION=ap-northeast-1
CLUSTER=vendor0919-cluster
SERVICE=vendor0919-service
ALB_NAME=vendor0919-alb-new
ALB_DNS=vendor0919-alb-new-619968933.ap-northeast-1.elb.amazonaws.com
TG_ARN=arn:aws:elasticloadbalancing:ap-northeast-1:067717894185:targetgroup/vendor0919-tg-new/1082e69f886174a0
S3_BUCKET=vendor-rag-0919
S3_PREFIX=vectorstore/prod
ECR_REPO=vendor0919-api
VPC=vpc-0484f20452b5a7773
ALB_SG=sg-0fa3ee4b2af769436

ひとこと

S3 対応の最後の壁は CodeBuild の buildspec 参照設定です。
ここを直して新タグを流せば、S3 に current/ が増え、 /health とログで確認できる段階まで到達します。