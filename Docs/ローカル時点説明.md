# リポジトリ現状調査レポート

## 1) リポジトリ構成の把握

```
repo/
├─ backend/
│  ├─ main.py
│  ├─ requirements.txt
│  ├─ Dockerfile
│  ├─ .dockerignore
│  └─ env.example
├─ frontend/
│  ├─ src/
│  │  ├─ app/
│  │  │  ├─ page.tsx
│  │  │  ├─ browse/page.tsx
│  │  │  ├─ kb/page.tsx
│  │  │  └─ search/page.tsx
│  │  ├─ components/ui/
│  │  ├─ lib/
│  │  └─ types/
│  ├─ package.json
│  └─ env.example
├─ rag_core/
│  ├─ __init__.py
│  ├─ chain.py
│  ├─ data_models.py
│  ├─ indexer.py
│  ├─ llm.py
│  ├─ loader.py
│  ├─ loaders/json_loader.py
│  ├─ splitter.py
│  └─ vectorstore.py
├─ buildspec.yml
└─ tools/reindex.py
```

## 2) バックエンド（FastAPI）

### backend/main.py の全文
```python
from fastapi import FastAPI, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional
import os
from dotenv import load_dotenv

# 環境変数の読み込み
load_dotenv()

app = FastAPI(title="Vendor RAG API", version="1.0.0")

# CORS設定
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Next.jsのデフォルトポート
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ヘルスチェック
@app.get("/health")
async def health_check():
    return {"status": "ok"}

# 認証エンドポイント（モック）
@app.post("/auth/verify", response_model=AuthResponse)
async def verify_credentials(auth: AuthRequest):
    # モック実装：実際の認証ロジックは後で実装
    if auth.email == "admin@example.com" and auth.password == "password":
        return AuthResponse(
            id="1",
            email=auth.email,
            org_id="org_1"
        )
    raise HTTPException(status_code=401, detail="Invalid credentials")

# 検索エンドポイント（モック）
@app.post("/search", response_model=SearchResponse)
async def search_vendors(request: SearchRequest):
    # モック実装：実際のRAG機能は後で実装
    mock_results = [
        SearchResult(
            id="vendor_1",
            title="LiberCraft",
            score=0.95,
            snippet="AI・機械学習を活用したスクラッチ開発サービス",
            metadata={"status": "面談済", "category": "スクラッチ"}
        ),
        SearchResult(
            id="vendor_2", 
            title="TechCorp",
            score=0.87,
            snippet="クラウドインフラ構築・運用支援",
            metadata={"status": "未面談", "category": "SaaS"}
        )
    ]
    
    return SearchResponse(hits=mock_results[:request.top_k])

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="127.0.0.1", port=8000)
```

### backend/requirements.txt の全文
```
fastapi==0.117.1
uvicorn[standard]==0.36.0
python-dotenv==1.1.1
pydantic[email]==2.11.9
python-jose[cryptography]==3.5.0
python-multipart==0.0.20
faiss-cpu==1.12.0
langchain==0.3.27
langchain-openai==0.3.33
langchain-community==0.3.29
```

### backend/Dockerfile の全文
```dockerfile
FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8080
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
```

### backend/.dockerignore の全文
```
__pycache__/
*.pyc
*.pyo
*.pyd
.Python
env/
venv/
build/
dist/
.git/
```

### rag_core.py の存在確認
**なし** - `rag_core/`ディレクトリに分散

### 検索結果
- **uvicorn起動コマンド**: `if __name__ == "__main__"`で`uvicorn.run(app, host="127.0.0.1", port=8000)`
- **app定義位置**: 11行目 `app = FastAPI(title="Vendor RAG API", version="1.0.0")`
- **CORSMiddleware設定**: あり、`allow_origins=["http://localhost:3000"]`
- **ポート不一致**: ローカル実行は8000、Dockerfileは8080

## 3) フロントエンド（Next.js）

### ルーティング
- **App Router使用**: `src/app/`ディレクトリ構成
- **ページ**: `page.tsx`, `browse/page.tsx`, `kb/page.tsx`, `search/page.tsx`

### API呼び先の実装箇所
```typescript
// frontend/src/app/search/page.tsx
const response = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/search`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    query,
    top_k: topK,
    mmr: 0.5,
  }),
});
```

### NEXT_PUBLIC_API_BASE の参照箇所
```typescript
// frontend/src/app/search/page.tsx:31
const response = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/search`, {
```

### package.json の scripts
```json
"scripts": {
  "dev": "next dev --turbopack",
  "build": "next build --turbopack", 
  "start": "next start",
  "lint": "eslint"
}
```

## 4) .env/設定

### リポジトリ内の .env* ファイル
- **backend/env.example**: あり
- **frontend/env.example**: あり
- **ルートの .env**: なし（.gitignoreで除外）

### 環境変数のキー
**backend/env.example**:
- `NEXTAUTH_SECRET`
- `VECTOR_DIR`
- `DATABASE_URL`
- `ALLOWED_ORIGINS`
- `OPENAI_API_KEY`

**frontend/env.example**:
- `NEXT_PUBLIC_API_BASE`
- `NEXTAUTH_URL`
- `NEXTAUTH_SECRET`

### 想定ポート
- **Frontend**: 3000 (Next.jsデフォルト)
- **Backend**: 8000 (ローカル) / 8080 (Docker)

## 5) ローカル実行とデプロイの差分

### ローカル開発の起動方法
- **Backend**: `uvicorn main:app --reload --host 0.0.0.0 --port 8000`
- **Frontend**: `npm run dev`

### Docker ビルド／実行での差異
- **EXPOSE**: 8080 (Dockerfile)
- **CMD**: `uvicorn main:app --host 0.0.0.0 --port 8080`
- **実行時マッピング**: `-p 8080:8080`

## 6) まとめ

### 現状の事実
- **ポート**: ローカル8000、Docker8080（不一致）
- **CORS**: `http://localhost:3000`のみ許可
- **エンドポイント**: `/health`, `/auth/verify`, `/search`（すべてモック）
- **環境変数**: `NEXT_PUBLIC_API_BASE=http://127.0.0.1:8000`

### 不足しているもの
- **rag_core.py**: なし（rag_core/ディレクトリに分散）
- **実際のRAG機能**: すべてモック実装
- **認証機能**: モックのみ
- **データベース接続**: 未実装

### すぐ直せる提案
- **ポート統一**: 8000に統一（DockerfileのEXPOSEとCMDを8000に変更）
- **CORS設定**: 本番環境のドメインを追加
- **RAG機能統合**: `rag_core/`の機能を`main.py`に統合
- **環境変数**: `.env`ファイルの作成と設定






















