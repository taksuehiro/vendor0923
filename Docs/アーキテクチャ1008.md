# ベンダー検索システム アーキテクチャ1008

## 📋 プロジェクト概要

本プロジェクトは、AIを活用したベンダー情報検索・分析プラットフォームです。自然言語での検索、データの分類・集計、ナレッジベース管理を統合した包括的なソリューションを提供しています。

### 🎯 主要な目的
- **効率的なベンダー検索**: 自然言語クエリによる直感的な検索
- **データ分析・分類**: 面談ステータス、上場区分、業界別の集計・分析
- **ナレッジベース管理**: ベンダー情報の構造化と可視化
- **スケーラブルなアーキテクチャ**: クラウド対応の分散システム

## 🏗️ システムアーキテクチャ

### 全体構成図
```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend Layer (Next.js)                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   検索UI        │  │   ブラウズUI    │  │   KBビューア  │ │
│  │  (自然言語検索)  │  │  (分類・集計)   │  │  (データ確認) │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Backend Layer (FastAPI)                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   RAG API       │  │   認証API       │  │   検索API    │ │
│  │  (ベクトル検索)  │  │  (NextAuth)     │  │  (RESTful)   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Data Processing Layer                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   RAG Core      │  │   Vector Store  │  │   Data Models│ │
│  │  (LangChain)    │  │   (FAISS/S3)    │  │  (Pydantic)  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   AWS Bedrock   │  │   S3 Storage    │  │   ECS/ALB    │ │
│  │   (Embeddings) │  │   (Vector DB) │  │  (Deployment)│ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🌳 システムロジックツリー

### 1. データフロー全体
```
ベンダーデータ管理
├── データ入力
│   ├── vendors.json (JSON形式)
│   ├── データ検証 (Pydantic)
│   └── 正規化処理
├── ベクトル化処理
│   ├── AWS Bedrock Embeddings
│   ├── 文書分割・チャンク化
│   └── メタデータ抽出
├── インデックス管理
│   ├── FAISS Index構築
│   ├── S3永続化
│   └── ローカルキャッシュ
└── 検索・分析
    ├── ベクトル検索
    ├── スコア計算
    └── 結果正規化
```

### 2. 検索機能ロジック
```
ユーザー検索リクエスト
├── クエリ受信
│   ├── 自然言語クエリ
│   ├── パラメータ検証
│   └── エラーハンドリング
├── ベクトル検索実行
│   ├── FAISS類似度検索
│   ├── TopK設定適用
│   └── スコア計算
├── 結果処理
│   ├── スコア正規化
│   ├── メタデータ付与
│   └── 結果ソート
└── レスポンス生成
    ├── JSON形式変換
    ├── エラーハンドリング
    └── クライアント返却
```

### 3. ブラウズ機能ロジック
```
データ分析・分類
├── データ集計
│   ├── 面談ステータス別集計
│   ├── 上場区分別集計
│   ├── タイプ別集計
│   └── カテゴリ別集計
├── フィルタリング
│   ├── 検索語フィルタ
│   ├── マルチセレクトフィルタ
│   ├── ドリルダウンフィルタ
│   └── 複合条件フィルタ
├── 表示制御
│   ├── 集計カード表示
│   ├── リスト表示
│   ├── 詳細表示
│   └── ページネーション
└── インタラクション
    ├── カードクリック処理
    ├── フィルタクリア
    ├── 状態管理
    └── UI更新
```

## 📁 プロジェクト構造詳細

### フロントエンド (Next.js 15)
```
frontend/
├── src/
│   ├── app/                    # App Router構成
│   │   ├── page.tsx           # ホームページ
│   │   ├── search/            # 検索UI
│   │   │   └── page.tsx       # 検索ページ
│   │   ├── browse/            # ブラウズUI（分類・集計）
│   │   │   └── page.tsx       # ブラウズページ
│   │   └── kb/                # ナレッジベース
│   │       └── page.tsx       # KBページ
│   ├── components/ui/          # shadcn/ui コンポーネント
│   │   ├── button.tsx         # ボタンコンポーネント
│   │   ├── card.tsx           # カードコンポーネント
│   │   ├── badge.tsx          # バッジコンポーネント
│   │   ├── checkbox.tsx       # チェックボックス
│   │   └── input.tsx          # 入力フィールド
│   ├── lib/                    # ユーティリティ関数
│   │   ├── apiBase.ts         # APIベースURL設定
│   │   ├── fetcher.ts         # API呼び出し関数
│   │   ├── searchApi.ts       # 検索API呼び出し
│   │   └── utils.ts            # 共通ユーティリティ
│   └── types/                 # TypeScript型定義
│       ├── index.ts          # 共通型定義
│       └── vendor.ts          # ベンダー型定義
├── package.json               # 依存関係管理
├── next.config.js            # Next.js設定
└── tsconfig.json             # TypeScript設定
```

### バックエンド (FastAPI)
```
backend/
├── main_app.py                # メインAPIエントリーポイント
├── models.py                  # Pydanticデータモデル
├── rag_core_s3.py            # S3ベクトルストア管理
├── requirements.txt           # Python依存関係
├── routers/
│   └── search.py             # 検索APIルーター
├── rag_core/
│   ├── core.py               # RAGコア機能
│   └── bedrock_embeddings_v2.py # AWS Bedrock Embeddings
└── data/
    └── vendors.json          # ベンダーデータ（JSON形式）
```

## 🔧 主要ファイル機能詳細

### フロントエンド主要ファイル

#### `frontend/src/app/search/page.tsx`
**機能**: 自然言語検索UI
- **検索クエリ入力**: ユーザーが自然言語で検索クエリを入力
- **API呼び出し**: バックエンドの検索APIを呼び出し
- **結果表示**: 検索結果をスコア付きで表示
- **エラーハンドリング**: 検索エラーの表示と処理
- **ローディング状態**: 検索中のローディング表示

#### `frontend/src/app/browse/page.tsx`
**機能**: データ分析・分類UI
- **集計カード表示**: 面談ステータス、上場区分、タイプ別の集計
- **ドリルダウン機能**: カードクリックによる条件絞り込み
- **マルチセレクトフィルタ**: 複数条件での絞り込み
- **検索機能**: ベンダー名での検索
- **フィルタクリア**: 条件のリセット機能
- **レスポンシブデザイン**: モバイル対応のレイアウト

#### `frontend/src/lib/searchApi.ts`
**機能**: 検索API呼び出し
- **API通信**: バックエンドとのHTTP通信
- **型安全性**: TypeScriptによる型チェック
- **エラーハンドリング**: API呼び出しエラーの処理
- **レスポンス正規化**: APIレスポンスの形式統一

### バックエンド主要ファイル

#### `backend/main_app.py`
**機能**: FastAPIアプリケーションのメインエントリーポイント
- **アプリケーション初期化**: FastAPIアプリの設定
- **CORS設定**: フロントエンドとの通信許可
- **ヘルスチェック**: `/health`エンドポイント
- **ルーター登録**: 検索APIルーターの登録
- **起動時処理**: ベクトルストアの初期化

#### `backend/routers/search.py`
**機能**: 検索APIエンドポイント
- **POST /search**: 検索リクエストの処理
- **ベクトルストア管理**: グローバルベクトルストアインスタンス
- **検索実行**: `do_search`関数による検索処理
- **結果正規化**: 検索結果の形式統一
- **エラーハンドリング**: 検索エラーの処理とログ出力

#### `backend/rag_core/core.py`
**機能**: RAGコア機能の実装
- **ベクトルストア構築**: `build_or_load_vectorstore`関数
- **S3同期**: S3からのベクトルストアダウンロード
- **FAISS読み込み**: ローカルFAISSインデックスの読み込み
- **検索実行**: `search_vendors`関数による類似度検索
- **設定管理**: 環境変数による設定管理

#### `backend/rag_core_s3.py`
**機能**: S3ベクトルストア管理
- **S3接続**: boto3によるS3クライアント
- **ファイル存在確認**: `exists_current`関数
- **ダウンロード**: `download_current_to`関数
- **アップロード**: `upload_to_staging`関数
- **同期処理**: `ensure_vectorstore_local`関数

#### `backend/models.py`
**機能**: Pydanticデータモデル定義
- **SearchRequest**: 検索リクエストの型定義
- **SearchHit**: 検索結果の型定義
- **SearchResponse**: 検索レスポンスの型定義
- **データ検証**: リクエスト・レスポンスの型チェック

## 🔄 データフロー詳細

### 1. データ読み込み・処理フロー
```
vendors.json → JSON Loader → 正規化 → Pydantic検証 → Document生成
     ↓
ベクトル化 → FAISS Index → S3 Storage → 永続化
     ↓
メタデータ抽出 → ブラウズUI用属性展開 → 集計・分類準備
```

### 2. 検索・回答フロー
```
ユーザークエリ → ベクトル検索 → 関連文書取得 → LLM統合 → 自然回答生成
     ↓
MMR適用 → スコア閾値 → 文脈構築 → プロンプト生成 → 回答出力
```

### 3. ブラウズ・分析フロー
```
ドキュメント → メタデータ抽出 → 集計処理 → フィルタリング → 階層表示
     ↓
集計カード → ドリルダウン → リスト表示 → 詳細表示
```

## 🧩 主要コンポーネント詳細

### 1. フロントエンド機能

#### 検索UI (`/search`)
- **自然言語検索**: ユーザーの質問を自然言語で受け取り、関連するベンダー情報を検索
- **スコア表示**: 検索結果の関連度スコアを表示
- **メタデータ表示**: 面談ステータス、カテゴリ、業界タグ等の詳細情報
- **TopK設定**: 検索結果件数の調整（1-20件）

#### ブラウズUI (`/browse`)
- **集計カード**: 面談ステータス、上場区分、タイプ別の社数をクリック可能なカードで表示
- **マルチセレクトフィルタ**: 複数条件での絞り込み機能
- **階層的ビュー**: 集計→リスト→詳細の3段階表示
- **ドリルダウン**: カードクリックによる直感的な絞り込み

#### ナレッジベース (`/kb`)
- **データ統計**: 全体のデータ統計情報を表示
- **メタデータ品質チェック**: データの完全性を確認
- **検索機能テスト**: システムの動作確認
- **サンプルデータプレビュー**: データの内容確認

### 2. バックエンド機能

#### RAG API (`/search`)
- **ベクトル検索**: FAISSベクトルストアを使用した高速検索
- **スコア計算**: コサイン類似度による関連度計算
- **メタデータ管理**: 検索結果に付随するメタデータの管理

#### 認証API (`/auth`)
- **NextAuth統合**: フロントエンドとの認証連携
- **セッション管理**: ユーザーセッションの管理
- **CORS対応**: クロスオリジンリクエストの処理

#### データ管理
- **S3統合**: ベクトルストアのS3保存・同期
- **ローカルキャッシュ**: 開発環境での高速アクセス
- **自動同期**: S3とローカル間の自動同期

### 3. RAG Core機能

#### ベクトル化処理
- **AWS Bedrock Titan Embeddings**: 高品質なベクトル生成
- **文書分割**: 適切なサイズでの文書分割
- **メタデータ抽出**: 検索・分析に必要な属性の抽出

#### 検索最適化
- **MMR (Maximum Marginal Relevance)**: 多様性を確保した検索結果
- **スコア閾値**: 品質の低い結果の除外
- **TopK調整**: 検索結果件数の最適化

## 🎯 主要機能詳細

### 1. 検索機能
- **自然言語クエリ**: 「契約書管理に強いベンダーを教えて」等の自然な質問に対応
- **関連度スコア**: 検索結果の関連度を数値で表示
- **メタデータ表示**: 面談ステータス、カテゴリ、業界タグ等の詳細情報
- **TopK設定**: 検索結果件数の調整（1-20件）

### 2. ブラウズ機能
- **面談ステータス別集計**: 面談済/未面談の社数を集計
- **上場区分別集計**: 上場/未上場の社数を集計
- **タイプ別集計**: SaaS/スクラッチ/SI等の社数を集計
- **クリック可能な集計カード**: カードクリックで該当条件の会社のみ表示
- **マルチセレクトフィルタ**: 複数条件での絞り込み

### 3. ナレッジベース機能
- **データ統計表示**: 全体のデータ統計情報
- **メタデータ品質チェック**: データの完全性確認
- **検索機能テスト**: システムの動作確認
- **サンプルデータプレビュー**: データ内容の確認

## 🛠️ 技術スタック

### フロントエンド
- **Next.js 15**: React フレームワーク（App Router）
- **TypeScript**: 型安全性の確保
- **Tailwind CSS**: ユーティリティファーストCSS
- **shadcn/ui**: 高品質なUIコンポーネント
- **NextAuth.js**: 認証機能

### バックエンド
- **FastAPI**: 高性能なPython Webフレームワーク
- **Pydantic**: データ検証・シリアライゼーション
- **LangChain**: RAG機能の実装
- **FAISS**: ベクトル検索エンジン

### インフラストラクチャ
- **AWS Bedrock**: 生成AI・埋め込みモデル
- **AWS S3**: ベクトルストアの永続化
- **AWS ECS**: コンテナオーケストレーション
- **AWS ALB**: ロードバランサー
- **AWS Amplify**: フロントエンドホスティング

## 📊 データ構造

### 入力データ形式
```json
{
  "vendor_id": "V-LiberCraft",
  "name": "LiberCraft",
  "type": "スクラッチ",
  "engagement": {"status": "面談済"},
  "capabilities": ["機械学習", "最適化", "LLM導入支援"],
  "offerings": {
    "products": ["Dify支援"],
    "description_short": "LLM導入/最適化のスクラッチ支援"
  },
  "delivery": {
    "deployment": "ハイブリッド",
    "is_scratch": true
  },
  "commercials": {"man_month_jpy": "200-300"},
  "corporate": {
    "listed": "未上場",
    "investors": [],
    "employees_band": "1-10"
  },
  "notes": "メンバーの大部分はデータサイエンティスト"
}
```

### 正規化後メタデータ
```python
{
    "vendor_id": "V-LiberCraft",
    "name": "LiberCraft",
    "status": "面談済",
    "category": "スクラッチ",
    "type": "スクラッチ",
    "listed": "未上場",
    "investors": [],
    "employees_band": "1-10",
    "is_scratch": True,
    "use_cases": ["機械学習", "最適化"],
    "industries": ["製造業", "金融"],
    "departments": ["法務", "人事"]
}
```

## 🚀 デプロイメント

### ローカル開発環境
```bash
# バックエンド起動
cd backend && uvicorn main_app:app --reload --port 8080

# フロントエンド起動
cd frontend && npm run dev
```

### 本番環境（AWS）
- **フロントエンド**: AWS Amplify（自動デプロイ）
- **バックエンド**: ECS (Fargate) + ALB（コンテナ化）
- **データ**: S3（ベクトルストア）+ EFS（共有ストレージ）
- **認証**: NextAuth.js（セッション管理）

## 🔧 設定・環境変数

### フロントエンド (.env.local)
```env
NEXT_PUBLIC_API_BASE=http://127.0.0.1:8080
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=dev-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### バックエンド (.env)
```env
NEXTAUTH_SECRET=dev-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
VECTOR_DIR=./vectorstore
DATABASE_URL=sqlite+aiosqlite:///./backend/dev.db
ALLOWED_ORIGINS=http://localhost:3000
OPENAI_API_KEY=sk-your-openai-api-key-here
VECTORSTORE_S3_BUCKET=your-bucket-name
VECTORSTORE_S3_PREFIX=vectorstore/prod
```

## 📈 パフォーマンス最適化

### 検索最適化
- **FAISS Index**: 高速ベクトル検索
- **S3統合**: 分散ストレージによるスケーラビリティ
- **ローカルキャッシュ**: 開発環境での高速アクセス
- **TopK調整**: 検索結果件数の最適化

### メモリ最適化
- **チャンクサイズ調整**: メモリ使用量の最適化
- **メタデータ管理**: 必要最小限のメタデータ保持
- **並列処理**: 複数クエリの並列実行

## 🔮 今後の拡張計画

### 1. 機能拡張
- **高度なフィルタリング**: 価格帯、従業員規模での絞り込み
- **比較機能**: 複数ベンダーの並列比較
- **エクスポート機能**: CSV、Excel形式でのデータ出力
- **ダッシュボード**: グラフ・チャートによる可視化

### 2. 技術拡張
- **マルチモーダル対応**: 画像、PDF等の他形式対応
- **リアルタイム更新**: WebSocketによるリアルタイム同期
- **API化**: REST API/GraphQL対応
- **機械学習**: 学習型ランキング機能

### 3. インフラ拡張
- **マイクロサービス化**: 機能別のサービス分割
- **Kubernetes対応**: より柔軟なオーケストレーション
- **監視・ログ**: 包括的な監視システム
- **セキュリティ**: より強固なセキュリティ対策

## 📋 運用・保守

### 監視項目
- **API応答時間**: 検索APIの応答時間監視
- **エラー率**: システムエラーの発生率監視
- **リソース使用量**: CPU、メモリ、ストレージ使用量
- **ユーザーアクティビティ**: 検索クエリ、ページビュー等

### バックアップ・復旧
- **S3バックアップ**: ベクトルストアの定期バックアップ
- **データベースバックアップ**: メタデータの定期バックアップ
- **災害復旧**: マルチリージョン対応

### セキュリティ
- **認証・認可**: NextAuth.jsによる安全な認証
- **CORS設定**: 適切なクロスオリジン設定
- **APIキー管理**: 環境変数による安全な管理
- **データ暗号化**: 転送時・保存時の暗号化

## 🎯 システム統合フロー

### 1. 開発フロー
```
コード変更 → Git Push → CI/CD → 自動テスト → デプロイ
     ↓
フロントエンド: Amplify自動デプロイ
バックエンド: ECS自動デプロイ
     ↓
本番環境更新
```

### 2. データ更新フロー
```
vendors.json更新 → ベクトル化処理 → FAISS Index更新
     ↓
S3アップロード → ステージング → 本番反映
     ↓
アプリケーション再起動 → 新データ反映
```

### 3. 監視・アラートフロー
```
システム監視 → メトリクス収集 → 閾値チェック
     ↓
アラート発生 → 通知送信 → 対応実施
     ↓
復旧確認 → アラート解除
```

---

このシステムは、ベンダー調査データの効率的な検索・分析・分類を目的とした、実用的で拡張性の高いRAGアーキテクチャを提供しています。検索、分析、ブラウズの3つの機能を統合し、ユーザーの様々なニーズに対応できる包括的なソリューションとなっています。

## 📚 参考資料

- [AWS Bedrock Documentation](https://docs.aws.amazon.com/bedrock/)
- [LangChain Documentation](https://python.langchain.com/)
- [Next.js Documentation](https://nextjs.org/docs)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [FAISS Documentation](https://faiss.ai/)

---

**最終更新**: 2024年10月8日  
**バージョン**: 1.0.0  
**作成者**: AI Assistant  
**レビュー**: システムアーキテクト
